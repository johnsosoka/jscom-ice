<div class="container-fluid mt-5">
  <form id="contactMeForm">
      <!-- Alert on Success/Failure -->
    <div id="notification" class="alert mt-3" role="alert" style="display: none;"></div>
    <div class="form-group">
      <input type="text" class="form-control" id="name" name="user_name" placeholder="Name">
    </div>
    <div class="form-group">
      <input type="email" class="form-control" id="mail" name="user_email" placeholder="Email">
    </div>
    <div class="form-group">
      <textarea class="form-control" id="msg" name="user_message" placeholder="Message"></textarea>
    </div>
    <div class="form-group d-flex justify-content-center my-3">
      <div class="cf-turnstile"
           data-sitekey="{{ site.turnstile.site_key }}"
           data-callback="onTurnstileSuccess"
           data-expired-callback="onTurnstileExpired"
           data-error-callback="onTurnstileError"
           data-theme="light">
      </div>
    </div>
    <div class="form-buttons">
      <button type="button" class="btn btn-primary" id="contact_submit" disabled>Send your message</button>
    </div>
  </form>
</div>

<!--&lt;!&ndash; TODO - this isn't working when using the scripts.html include ... &ndash;&gt;-->
<script src="/assets/js/jquery-3.7.0.min.js"></script>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  var turnstileToken = null;

  function onTurnstileSuccess(token) {
    turnstileToken = token;
    $('#contact_submit').prop('disabled', false);
  }

  function onTurnstileExpired() {
    turnstileToken = null;
    $('#contact_submit').prop('disabled', true);
  }

  function onTurnstileError() {
    turnstileToken = null;
    $('#contact_submit').prop('disabled', true);
  }

  function submitContact(payload) {
    $.ajax({
      url : "{{ site.contact.api.url }}",
      type: "POST",
      dataType: "json",
      data: payload,
      success: function(data){
        console.log(data);
        $('#notification').removeClass('alert-danger').addClass('alert-success').text('Message Sent!').show();
        clearForm();
        if (typeof turnstile !== 'undefined') {
          turnstile.reset();
        }
        turnstileToken = null;
        $('#contact_submit').prop('disabled', true);
      },
      error: function(){
        console.log("Error in the request");
        $('#notification').removeClass('alert-success').addClass('alert-danger').text('Something went wrong :(').show();
      }
    });
  }

  function clearForm() {
    $('#name').val('');
    $('#mail').val('');
    $('#msg').val('');
  }

  function buildPayload() {
    var contactMePayload = {
      contact_name : $('#name').val(),
      contact_email : $('#mail').val(),
      contact_message : $('#msg').val(),
      turnstile_token: turnstileToken,
      turnstile_site: "johnsosoka.com"
    };

    return JSON.stringify(contactMePayload);
  }

  $('#contact_submit').click(function() {
    if (!turnstileToken) {
      $('#notification').removeClass('alert-success').addClass('alert-danger')
        .text('Please complete the security verification').show();
      return;
    }
    var payload = buildPayload();
    console.log(payload);
    submitContact(payload);
  });
</script>

<!-- TODO - this isn't working with my self hosted jquery?? -->
